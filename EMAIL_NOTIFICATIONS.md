# Email Notification System

This document describes the email notification system implemented for the B2B Vegetable platform.

## Overview

The email notification system automatically sends emails for key events in the order lifecycle:

1. **Driver Assignment**: When an admin assigns a driver to an order
2. **Order Completion**: When a driver marks an order as completed

## Features

### ðŸšš Driver Assignment Notifications
- **Trigger**: Admin assigns a driver to an order
- **Recipient**: Driver
- **Content**: Order details, customer information, special instructions
- **Languages**: English, German, Vietnamese
- **Template**: Professional HTML with company branding

### âœ… Order Completion Notifications
- **Trigger**: Driver marks order as completed
- **Recipients**: Customer and Admin
- **Content**: Delivery confirmation, order summary, completion details
- **Languages**: English, German, Vietnamese
- **Templates**: Separate templates for customer and admin

## Implementation

### Core Files

#### Email API (`src/app/lib/email-api.ts`)
- `sendDriverAssignmentEmail()` - Sends assignment notification to driver
- `sendOrderCompletionEmails()` - Sends completion notifications to customer and admin
- `sendInvoiceEmail()` - Existing invoice functionality

#### Email Route (`src/app/api/send-email/route.ts`)
- Handles different email types: `driver_assignment`, `order_completion_customer`, `order_completion_admin`, `invoice`
- Professional HTML email templates with responsive design
- Company branding and contact information
- **Simplified payload format**: Uses basic email structure with `from`, `to`, `subject`, and `html`

#### Order API Integration (`src/app/lib/order-api.ts`)
- `assignDriverToOrder()` - Enhanced to send driver assignment email
- `updateOrderStatus()` - Enhanced to send completion emails when status is 'completed'

### Email Payload Format

The system uses a simplified email payload format for Supabase Edge Functions:

```json
{
  "from": "support@yourcompany.com",
  "to": "recipient@example.com",
  "subject": "Email Subject",
  "html": "<html>Email content...</html>"
}
```

**From Email Address**: The "from" field is dynamically determined from app settings:
- **Primary**: Uses the Support Email from app settings (`appSettings.supportEmail`)
- **Fallback**: Uses `'info@edukidstaynguyen.com'` if no support email is configured

This format is automatically generated by the API route based on the email type and data provided.

### Email Templates

#### Driver Assignment Email
```html
- Company header with branding
- Greeting with driver name
- Order details (ID, date, status)
- Customer information (name, contact, address)
- Order items table
- Special instructions (if any)
- Call-to-action to log into dashboard
- Company footer with contact info
```

#### Customer Completion Email
```html
- Success header with checkmark
- Personalized greeting
- Delivery confirmation message
- Order details and delivery info
- Items delivered list
- Satisfaction message
- Thank you and contact information
```

#### Admin Completion Email
```html
- Professional header
- Status update notification
- Completion details (driver, date, time)
- Customer and order information
- Order summary with financial details
- Items delivered table
- Automatic notification disclaimer
```

### Translations

Email content is available in multiple languages:

#### English (`src/messages/en/common.json`)
```json
"emails": {
  "driverAssignment": { ... },
  "orderCompletion": {
    "customer": { ... },
    "admin": { ... }
  },
  "common": { ... }
}
```

#### German (`src/messages/de/common.json`)
Professional German translations for all email content.

#### Vietnamese (`src/messages/vi/common.json`)
Native Vietnamese translations for all email content.

## Usage

### Automatic Triggers

The email notifications are automatically triggered by the following actions:

1. **Admin assigns driver to order**:
   ```typescript
   await assignDriverToOrder(orderId, driverId);
   // Automatically sends email to driver
   ```

2. **Driver marks order as completed**:
   ```typescript
   await updateOrderStatus(orderId, 'completed');
   // Automatically sends emails to customer and admin
   ```

### Manual Testing

A test page is available at `/admin/test-emails` for testing email functionality:

- Input order ID, driver ID, and optional admin ID
- Test driver assignment emails
- Test order completion emails
- View success/error messages

### API Usage

#### Send Driver Assignment Email
```typescript
import { sendDriverAssignmentEmail } from '@/app/lib/email-api';

await sendDriverAssignmentEmail(orderId, driverId, adminId);
```

#### Send Order Completion Emails
```typescript
import { sendOrderCompletionEmails } from '@/app/lib/email-api';

await sendOrderCompletionEmails(orderId, driverId);
```

## Configuration

### Environment Variables

Ensure the following environment variables are set:

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### Supabase Edge Function

The system uses Supabase Edge Functions for email delivery with a simplified payload format:

```javascript
// Expected payload format for the send-email edge function
{
  from: "support@yourcompany.com", // Dynamic: from app settings or fallback
  to: "recipient@example.com", 
  subject: "Email Subject",
  html: "<html>Email content...</html>"
}
```

### App Settings

Email templates use app settings for:
- Company name
- Support email
- Currency formatting
- Contact information

## Error Handling

- Email failures don't prevent order operations
- Errors are logged but don't throw exceptions
- Graceful fallbacks for missing data
- User-friendly error messages in test interface

## Security

- Server-side email sending using Supabase service role
- Input validation and sanitization
- Rate limiting through Supabase Edge Functions
- Secure handling of user data
- **Dynamic sender email**: Uses configured Support Email from app settings with secure fallback

## Monitoring

- Email sending events are logged to `email_logs` table
- Success/failure status tracking
- Order ID and recipient tracking
- Email type classification

## Technical Details

### Email Generation Flow

1. **API Call**: Frontend calls email API function
2. **Data Gathering**: System fetches order, user, and app settings data
3. **Template Generation**: HTML email template is generated based on type
4. **Payload Creation**: Simple payload with from/to/subject/html is created
5. **Supabase Function**: Edge function receives simplified payload
6. **Email Delivery**: Email is sent via configured email service
7. **Logging**: Event is logged to database

### Payload Simplification Benefits

- **Cleaner Interface**: Simple, standard email format
- **Better Compatibility**: Works with any email service
- **Easier Debugging**: Clear, readable payload structure
- **Reduced Complexity**: No custom data structures in edge function
- **Standard Format**: Follows common email API patterns

## Future Enhancements

Potential improvements for the email system:

1. **Email Templates Editor**: Admin interface to customize email templates
2. **Email Preferences**: User settings for email notifications
3. **SMS Notifications**: Alternative notification method
4. **Email Analytics**: Open rates, click tracking
5. **Scheduled Emails**: Reminder emails for pending deliveries
6. **Rich Media**: Product images in email templates
7. **Email Queuing**: Batch processing for high volume
8. **Multiple Senders**: Different sender addresses for different email types

## Troubleshooting

### Common Issues

1. **Emails not sending**:
   - Check Supabase Edge Function deployment
   - Verify environment variables
   - Check email logs table
   - Verify sender email configuration

2. **Missing order data**:
   - Ensure order exists in database
   - Check order items are properly loaded
   - Verify user relationships

3. **Template rendering issues**:
   - Check for missing app settings
   - Verify translation keys exist
   - Test with different locales

### Debug Mode

Use the test page at `/admin/test-emails` to:
- Test email functionality
- Verify template rendering
- Check error messages
- Validate email delivery

### Payload Verification

To verify the email payload format, check the browser network tab or server logs for the exact JSON being sent to the Supabase Edge Function:

```json
{
  "from": "support@yourcompany.com",
  "to": "driver@example.com",
  "subject": "New Delivery Assignment - Order #abc12345",
  "html": "<!DOCTYPE html><html>...</html>"
}
```

**Note**: The "from" email will be your configured Support Email from app settings, or fall back to `'info@edukidstaynguyen.com'` if not configured.

## Support

For issues or questions about the email notification system:

1. Check the test page for immediate debugging
2. Review server logs for detailed error information
3. Verify Supabase Edge Function status
4. Ensure payload format matches expected structure
5. Contact the development team for assistance 